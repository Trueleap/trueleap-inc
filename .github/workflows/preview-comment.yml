name: Post admin link on content PR

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  preview-comment:
    if: startsWith(github.head_ref, 'content/')
    runs-on: ubuntu-latest
    steps:
      - name: Generate CMS URL
        id: cms
        run: |
          branch="${{ github.head_ref }}"
          encoded=$(echo "$branch" | sed 's|/|%2F|g')
          echo "url=https://trueleapinc.com/keystatic/branch/${encoded}" >> "$GITHUB_OUTPUT"

      - name: Delete previous bot comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          comments=$(gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" --jq '.[] | select(.body | startswith("## Content")) | .id')
          for id in $comments; do
            gh api -X DELETE "repos/${{ github.repository }}/issues/comments/$id"
          done

      - name: Post comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --body "## Content Branch

          **Branch:** \`${{ github.head_ref }}\`
          **Edit in CMS:** ${{ steps.cms.outputs.url }}
          **Admin Dashboard:** https://trueleapinc.com/admin"
